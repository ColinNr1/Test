<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Excel Import â€“ Debug mit Progress</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
body{
  background:#0b1020;
  color:#e7ecff;
  font-family:Arial, sans-serif;
  padding:20px;
}
h1{margin-bottom:5px}
input,button{
  padding:10px;
  margin:5px 0;
}
#progressWrap{
  width:100%;
  background:#222;
  border-radius:6px;
  overflow:hidden;
  margin-top:10px;
  height:20px;
}
#progressBar{
  height:100%;
  width:0%;
  background:#7c5cff;
  transition:width .2s;
}
#log{
  background:#000;
  padding:10px;
  margin-top:15px;
  font-size:12px;
  max-height:200px;
  overflow:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  font-size:12px;
}
th,td{
  border:1px solid #333;
  padding:6px;
}
th{
  background:#101a33;
  position:sticky;
  top:0;
}
tr:nth-child(even){
  background:#111;
}
</style>
</head>

<body>

<h1>Excel Import â€“ sichtbar & sicher</h1>
<p>Wenn hier Logs erscheinen, lÃ¤uft JavaScript korrekt.</p>

<input type="file" id="fileInput" accept=".xlsx,.xls">
<button onclick="importExcel()">Excel importieren</button>

<div id="progressWrap">
  <div id="progressBar"></div>
</div>

<pre id="log"></pre>

<table id="table">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
const logEl = document.getElementById("log");
const progressBar = document.getElementById("progressBar");

function log(msg){
  console.log(msg);
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

log("âœ… Script geladen");

function setProgress(p){
  progressBar.style.width = p + "%";
}

function importExcel(){
  log("â–¶ Import gestartet");
  setProgress(5);

  const file = document.getElementById("fileInput").files[0];
  if(!file){
    alert("Bitte Excel-Datei auswÃ¤hlen");
    log("âŒ Keine Datei ausgewÃ¤hlt");
    return;
  }

  log("ðŸ“‚ Datei erkannt: " + file.name);
  setProgress(10);

  const reader = new FileReader();

  reader.onerror = () => {
    log("âŒ FileReader Fehler");
  };

  reader.onload = (e) => {
    log("ðŸ“¥ Datei gelesen (ArrayBuffer)");
    setProgress(30);

    try{
      const data = new Uint8Array(e.target.result);
      log("ðŸ§  XLSX.read()");
      const workbook = XLSX.read(data, { type: "array" });

      log("ðŸ“„ Sheets gefunden: " + workbook.SheetNames.join(", "));
      const sheet = workbook.Sheets[workbook.SheetNames[0]];

      setProgress(50);
      log("ðŸ”„ Sheet â†’ JSON");

      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      log("ðŸ“Š Zeilen gesamt: " + rows.length);
      setProgress(70);

      renderTable(rows);
      setProgress(100);
      log("âœ… Import abgeschlossen â€“ Tabelle gerendert");

    }catch(err){
      log("âŒ FEHLER: " + err.message);
    }
  };

  reader.readAsArrayBuffer(file);
}

function renderTable(rows){
  if(!rows || !rows.length){
    log("âš  Keine Daten im Sheet");
    return;
  }

  const thead = document.querySelector("#table thead");
  const tbody = document.querySelector("#table tbody");

  thead.innerHTML = "";
  tbody.innerHTML = "";

  // Header
  const hr = document.createElement("tr");
  rows[0].forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    hr.appendChild(th);
  });
  thead.appendChild(hr);

  // Rows
  for(let i=1;i<rows.length;i++){
    const tr = document.createElement("tr");
    rows[i].forEach(c => {
      const td = document.createElement("td");
      td.textContent = c ?? "";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
}
</script>

</body>
</html>
